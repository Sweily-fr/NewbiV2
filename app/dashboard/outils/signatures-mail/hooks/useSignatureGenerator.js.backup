/**
 * Hook personnalis√© pour la g√©n√©ration de signatures HTML
 */

import { useSignatureData } from '@/src/hooks/use-signature-data';
import { SocialIcons } from '@/src/components/social-icons';

export function useSignatureGenerator() {
  const { signatureData } = useSignatureData();

  // G√©n√©rer le HTML de la signature
  const generateHTML = () => {
    // Fonction helper pour obtenir l'espacement appropri√©
    const getSpacing = (specificSpacing, fallbackSpacing = 8) => {
      let result;
      // Si le mode d√©taill√© est activ√©, utiliser l'espacement sp√©cifique
      if (signatureData.detailedSpacing && specificSpacing !== undefined) {
        result = specificSpacing;
      } else {
        // Sinon, utiliser l'espacement global ou le fallback
        result = signatureData.spacings?.global || fallbackSpacing;
      }
      
      console.log(`üîç getSpacing - specific: ${specificSpacing}, fallback: ${fallbackSpacing}, detailedMode: ${signatureData.detailedSpacing}, global: ${signatureData.spacings?.global}, result: ${result}`);
      return result;
    };

    // Fonction helper pour obtenir les valeurs de typographie (nouvelle structure d√©taill√©e ou ancienne)
    const getTypography = (field, property, fallback) => {
      // Priorit√© √† la nouvelle structure d√©taill√©e
      const detailedValue = signatureData.typography?.[field]?.[property];
      if (detailedValue !== undefined) {
        return detailedValue;
      }
      
      // Fallback vers l'ancienne structure
      if (property === 'fontSize') {
        return signatureData.fontSize?.[field === 'fullName' ? 'name' : field] || fallback;
      } else if (property === 'color') {
        return signatureData.colors?.[field === 'fullName' ? 'name' : field] || fallback;
      } else if (property === 'fontFamily') {
        return signatureData.fontFamily || fallback;
      } else if (property === 'fontWeight') {
        return fallback;
      }
      
      return fallback;
    };

    const profileImageHTML = signatureData.photo 
      ? `<div style="width: ${signatureData.imageSize || 80}px; height: ${signatureData.imageSize || 80}px; border-radius: ${signatureData.imageShape === 'square' ? '8px' : '50%'}; background: url('${signatureData.photo}') center center/cover no-repeat; display: block;"></div>`
      : '';

    const logoHTML = signatureData.logo 
      ? `<img src="${signatureData.logo}" alt="Logo entreprise" style="max-width: ${signatureData.logoSize || 60}px; height: auto; display: block; margin: 0;" />`
      : '';

    const isHorizontal = signatureData.orientation === 'horizontal';
    console.log("üîç DEBUG HOOK generateHTML - Orientation:", signatureData.orientation, "isHorizontal:", isHorizontal);

    if (isHorizontal) {
      // Structure horizontale
      return `
        <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse; max-width: 500px; font-family: ${signatureData.fontFamily || 'Arial, sans-serif'};">
          <tbody>
            <tr>
              ${profileImageHTML ? `<td style="width: ${signatureData.imageSize || 80}px; padding-right: 16px; vertical-align: top;">${profileImageHTML}</td>` : ''}
              <td style="vertical-align: top;">
                <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse; table-layout: auto; width: auto;">
                  <tbody>
                    <tr>
                      <td colspan="2" style="text-align: ${signatureData.nameAlignment || 'left'}; padding-bottom: ${getSpacing(signatureData.spacings?.nameBottom, 8)}px;">
                        <span style="font-size: ${getTypography('fullName', 'fontSize', 16)}px; font-weight: ${getTypography('fullName', 'fontWeight', 'bold')}; color: ${getTypography('fullName', 'color', signatureData.primaryColor || '#2563eb')}; line-height: 1.2; font-family: ${getTypography('fullName', 'fontFamily', 'Arial, sans-serif')};">
                          ${signatureData.fullName || `${signatureData.firstName || ''} ${signatureData.lastName || ''}`.trim()}
                        </span>
                      </td>
                    </tr>
                    ${signatureData.position ? `
                      <tr>
                        <td colspan="2" style="padding-bottom: ${getSpacing(signatureData.spacings?.positionBottom, 8)}px;">
                          <span style="font-size: ${getTypography('position', 'fontSize', 14)}px; color: ${getTypography('position', 'color', 'rgb(102,102,102)')}; font-weight: ${getTypography('position', 'fontWeight', 'normal')}; font-family: ${getTypography('position', 'fontFamily', 'Arial, sans-serif')};">${signatureData.position}</span>
                        </td>
                      </tr>
                    ` : ''}
                    ${signatureData.phone ? `
                      <tr>
                        <td style="padding-bottom: ${getSpacing(signatureData.spacings?.phoneToMobile, 4)}px; padding-right: 10px; vertical-align: top; width: 20px;">
                          <img src="https://cdn-icons-png.flaticon.com/512/126/126509.png" alt="T√©l√©phone" width="16" height="16" style="width: 16px !important; height: 16px !important; display: block; margin-top: 2px; min-width: 16px;" />
                        </td>
                        <td style="font-size: ${getTypography('phone', 'fontSize', 12)}px; color: ${getTypography('phone', 'color', 'rgb(102,102,102)')}; font-weight: ${getTypography('phone', 'fontWeight', 'normal')}; vertical-align: top; padding-bottom: ${getSpacing(signatureData.spacings?.phoneToMobile, 4)}px; font-family: ${getTypography('phone', 'fontFamily', 'Arial, sans-serif')};">
                          <a href="tel:${signatureData.phone}" style="color: ${getTypography('phone', 'color', 'rgb(102,102,102)')}; text-decoration: none;">${signatureData.phone}</a>
                        </td>
                      </tr>
                    ` : ''}
                    ${signatureData.email ? `
                      <tr>
                        <td style="padding-bottom: ${getSpacing(signatureData.spacings?.mobileToEmail, 4)}px; padding-right: 10px; vertical-align: top; width: 20px;">
                          <img src="https://cdn-icons-png.flaticon.com/512/542/542689.png" alt="Email" width="16" height="16" style="width: 16px !important; height: 16px !important; display: block; margin-top: 2px; min-width: 16px;" />
                        </td>
                        <td style="font-size: ${signatureData.fontSize?.contact || 12}px; color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; vertical-align: top; padding-bottom: ${getSpacing(signatureData.spacings?.mobileToEmail, 4)}px; font-family: ${signatureData.fontFamily || 'Arial, sans-serif'};">
                          <a href="mailto:${signatureData.email}" style="color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; text-decoration: none;">${signatureData.email}</a>
                        </td>
                      </tr>
                    ` : ''}
                    ${signatureData.website ? `
                      <tr>
                        <td style="padding-bottom: ${getSpacing(signatureData.spacings?.emailToWebsite, 4)}px; padding-right: 10px; vertical-align: top; width: 20px;">
                          <img src="https://cdn-icons-png.flaticon.com/512/1006/1006771.png" alt="Site web" width="16" height="16" style="width: 16px !important; height: 16px !important; display: block; margin-top: 2px; min-width: 16px;" />
                        </td>
                        <td style="font-size: ${signatureData.fontSize?.contact || 12}px; color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; vertical-align: top; padding-bottom: ${getSpacing(signatureData.spacings?.emailToWebsite, 4)}px; font-family: ${signatureData.fontFamily || 'Arial, sans-serif'};">
                          <a href="${signatureData.website}" style="color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; text-decoration: none;">${signatureData.website}</a>
                        </td>
                      </tr>
                    ` : ''}
                    ${signatureData.address ? `
                      <tr>
                        <td style="padding-bottom: ${getSpacing(signatureData.spacings?.websiteToAddress, 4)}px; padding-right: 10px; vertical-align: top; width: 20px;">
                          <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" alt="Adresse" width="16" height="16" style="width: 16px !important; height: 16px !important; display: block; margin-top: 2px; min-width: 16px;" />
                        </td>
                        <td style="font-size: ${signatureData.fontSize?.contact || 12}px; color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; vertical-align: top; padding-bottom: ${getSpacing(signatureData.spacings?.websiteToAddress, 4)}px; font-family: ${signatureData.fontFamily || 'Arial, sans-serif'};">
                          ${signatureData.address}
                        </td>
                      </tr>
                    ` : ''}
                    <tr>
                      <td colspan="2" style="padding-top: ${getSpacing(signatureData.spacings?.separatorTop, 8)}px; padding-bottom: ${getSpacing(signatureData.spacings?.separatorBottom, 8)}px;">
                        <hr style="border: none; border-top: ${signatureData.separators?.horizontal?.width || 0.5}px solid ${signatureData.separators?.horizontal?.color || '#e0e0e0'}; margin: 0; width: 100%;" />
                      </td>
                    </tr>
                    ${logoHTML ? `
                      <tr>
                        <td colspan="2" style="padding-top: ${getSpacing(signatureData.spacings?.logoBottom, 8)}px; text-align: left;">
                          ${logoHTML}
                        </td>
                      </tr>
                    ` : ''}
                  </tbody>
                </table>
              </td>
            </tr>
          </tbody>
        </table>
      `;
    } else {
      // Structure verticale avec s√©parateur
      return `
        <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse; max-width: 500px; font-family: ${signatureData.fontFamily || 'Arial, sans-serif'};">
          <tbody>
            <tr>
              <!-- Colonne de gauche : Informations personnelles -->
              <td style="padding-right: ${getSpacing(signatureData.spacings?.verticalSeparatorLeft, 15)}px; vertical-align: top;">
                <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse; width: 100%;">
                  <tbody>
                    ${profileImageHTML ? `
                      <tr>
                        <td style="padding-bottom: ${getSpacing(signatureData.spacings?.photoBottom, 12)}px; text-align: ${signatureData.nameAlignment || 'left'};">
                          ${profileImageHTML}
                        </td>
                      </tr>
                    ` : ''}
                    <tr>
                      <td style="padding-bottom: ${getSpacing(signatureData.spacings?.nameBottom, 8)}px; text-align: ${signatureData.nameAlignment || 'left'};">
                        <div style="font-size: ${signatureData.fontSize?.name || 16}px; font-weight: bold; color: ${signatureData.colors?.name || signatureData.primaryColor || '#2563eb'}; line-height: 1.2; font-family: ${signatureData.fontFamily || 'Arial, sans-serif'};">
                          ${signatureData.fullName || `${signatureData.firstName || ''} ${signatureData.lastName || ''}`.trim()}
                        </div>
                      </td>
                    </tr>
                    ${signatureData.position ? `
                      <tr>
                        <td style="padding-bottom: ${getSpacing(signatureData.spacings?.positionBottom, 8)}px; text-align: ${signatureData.nameAlignment || 'left'};">
                          <div style="font-size: ${signatureData.fontSize?.position || 14}px; color: ${signatureData.colors?.position || 'rgb(102,102,102)'}; font-family: ${signatureData.fontFamily || 'Arial, sans-serif'};">
                            ${signatureData.position}
                          </div>
                        </td>
                      </tr>
                    ` : ''}
                    ${signatureData.companyName ? `
                      <tr>
                        <td style="padding-bottom: ${getSpacing(signatureData.spacings?.companyBottom, 8)}px; text-align: ${signatureData.nameAlignment || 'left'};">
                          <div style="font-size: ${signatureData.fontSize?.position || 14}px; font-weight: bold; color: ${signatureData.colors?.company || signatureData.primaryColor || '#2563eb'}; font-family: ${signatureData.fontFamily || 'Arial, sans-serif'};">
                            ${signatureData.companyName}
                          </div>
                        </td>
                      </tr>
                    ` : ''}
                  </tbody>
                </table>
              </td>
              
              <!-- S√©parateur vertical -->
              <td style="width: ${signatureData.separators?.vertical?.width || 1}px; background-color: ${signatureData.separators?.vertical?.color || '#e0e0e0'}; padding: 0; font-size: 1px; line-height: 1px;">
                &nbsp;
              </td>
              
              <!-- Colonne de droite : Informations de contact -->
              <td style="padding-left: ${getSpacing(signatureData.spacings?.verticalSeparatorRight, 15)}px; vertical-align: top; width: 200px;">
                <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse; width: 100%;">
                  <tbody>
                    ${signatureData.phone ? `
                      <tr>
                        <td style="padding-bottom: ${getSpacing(signatureData.spacings?.phoneToMobile, 6)}px;">
                          <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
                            <tbody>
                              <tr>
                                <td style="padding-right: 8px; vertical-align: middle; width: 12px;">
                                  <img src="https://cdn-icons-png.flaticon.com/512/126/126509.png" alt="T√©l√©phone" width="12" height="12" style="width: 12px !important; height: 12px !important; display: block;" />
                                </td>
                                <td style="font-size: ${getTypography('phone', 'fontSize', 12)}px; color: ${getTypography('phone', 'color', 'rgb(102,102,102)')}; font-weight: ${getTypography('phone', 'fontWeight', 'normal')}; vertical-align: middle; font-family: ${getTypography('phone', 'fontFamily', 'Arial, sans-serif')};">
                                  <a href="tel:${signatureData.phone}" style="color: ${getTypography('phone', 'color', 'rgb(102,102,102)')}; text-decoration: none;">${signatureData.phone}</a>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                    ` : ''}
                    ${signatureData.mobile ? `
                      <tr>
                        <td style="padding-bottom: ${getSpacing(signatureData.spacings?.mobileToEmail, 6)}px;">
                          <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
                            <tbody>
                              <tr>
                                <td style="padding-right: 8px; vertical-align: middle; width: 12px;">
                                  <img src="https://cdn-icons-png.flaticon.com/512/126/126509.png" alt="Mobile" width="12" height="12" style="width: 12px !important; height: 12px !important; display: block;" />
                                </td>
                                <td style="font-size: ${getTypography('mobile', 'fontSize', 12)}px; color: ${getTypography('mobile', 'color', 'rgb(102,102,102)')}; font-weight: ${getTypography('mobile', 'fontWeight', 'normal')}; vertical-align: middle; font-family: ${getTypography('mobile', 'fontFamily', 'Arial, sans-serif')};">
                                  <a href="tel:${signatureData.mobile}" style="color: ${getTypography('mobile', 'color', 'rgb(102,102,102)')}; text-decoration: none;">${signatureData.mobile}</a>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                    ` : ''}
                    ${signatureData.email ? `
                      <tr>
                        <td style="padding-bottom: ${getSpacing(signatureData.spacings?.emailToWebsite, 6)}px;">
                          <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
                            <tbody>
                              <tr>
                                <td style="padding-right: 8px; vertical-align: middle; width: 12px;">
                                  <img src="https://cdn-icons-png.flaticon.com/512/542/542689.png" alt="Email" width="12" height="12" style="width: 12px !important; height: 12px !important; display: block;" />
                                </td>
                                <td style="font-size: ${getTypography('email', 'fontSize', 12)}px; color: ${getTypography('email', 'color', 'rgb(102,102,102)')}; font-weight: ${getTypography('email', 'fontWeight', 'normal')}; vertical-align: middle; font-family: ${getTypography('email', 'fontFamily', 'Arial, sans-serif')};">
                                  <a href="mailto:${signatureData.email}" style="color: ${getTypography('email', 'color', 'rgb(102,102,102)')}; text-decoration: none;">${signatureData.email}</a>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                    ` : ''}
                    ${signatureData.website ? `
                      <tr>
                        <td style="padding-bottom: ${getSpacing(signatureData.spacings?.websiteToAddress, 6)}px;">
                          <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
                            <tbody>
                              <tr>
                                <td style="padding-right: 8px; vertical-align: middle; width: 12px;">
                                  <img src="https://cdn-icons-png.flaticon.com/512/1006/1006771.png" alt="Site web" width="12" height="12" style="width: 12px !important; height: 12px !important; display: block;" />
                                </td>
                                <td style="font-size: ${getTypography('website', 'fontSize', 12)}px; color: ${getTypography('website', 'color', 'rgb(102,102,102)')}; font-weight: ${getTypography('website', 'fontWeight', 'normal')}; vertical-align: middle; font-family: ${getTypography('website', 'fontFamily', 'Arial, sans-serif')};">
                                  <a href="${signatureData.website}" style="color: ${getTypography('website', 'color', 'rgb(102,102,102)')}; text-decoration: none;">${signatureData.website}</a>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                    ` : ''}
                    ${signatureData.address ? `
                      <tr>
                        <td style="padding-bottom: 12px;">
                          <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
                            <tbody>
                              <tr>
                                <td style="padding-right: 8px; vertical-align: top; width: 12px;">
                                  <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" alt="Adresse" width="12" height="12" style="width: 12px !important; height: 12px !important; display: block; margin-top: 1px;" />
                                </td>
                                <td style="font-size: ${getTypography('address', 'fontSize', 12)}px; color: ${getTypography('address', 'color', 'rgb(102,102,102)')}; font-weight: ${getTypography('address', 'fontWeight', 'normal')}; vertical-align: top; font-family: ${getTypography('address', 'fontFamily', 'Arial, sans-serif')};">
                                  ${signatureData.address}
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                    ` : ''}
                    
                    <!-- S√©parateur horizontal apr√®s tous les contacts -->
                    <tr>
                      <td style="padding-top: ${signatureData.spacings?.separatorTop || 12}px; padding-bottom: ${signatureData.spacings?.separatorBottom || 12}px;">
                        <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse; width: 100%;">
                          <tbody>
                            <tr>
                              <td style="border-top: ${signatureData.separators?.horizontal?.width || 1}px solid ${signatureData.separators?.horizontal?.color || '#e0e0e0'}; line-height: 1px; font-size: 1px;">&nbsp;</td>
                            </tr>
                          </tbody>
                        </table>
                      </td>
                    </tr>
                    
                    <!-- Logo entreprise apr√®s le s√©parateur -->
                    ${logoHTML ? `
                      <tr>
                        <td style="padding-top: ${signatureData.spacings?.logoBottom || 12}px; text-align: center;">
                          <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse; margin: 0 auto;">
                            <tbody>
                              <tr>
                                <td style="text-align: center;">
                                  ${logoHTML}
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                    ` : ''}
                  </tbody>
                </table>
              </td>
            </tr>
          </tbody>
        </table>
      `;
    }
  };

  // G√©n√©rer le CSS pour la pr√©visualisation
  const generateCSS = () => {
    return `
      .signature-preview {
        font-family: ${signature.appearance.fontFamily};
        font-size: ${signature.appearance.fontSize};
        color: #333;
        line-height: 1.4;
        max-width: 600px;
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
      }
    `;
  };

  // G√©n√©rer le HTML optimis√© pour les clients mail avec cellules vides pour espacements
  const generateEmailHTML = () => {
    // Fonction helper pour obtenir l'espacement appropri√©
    const getSpacing = (specificSpacing, fallbackSpacing = 8) => {
      let result;
      // Si le mode d√©taill√© est activ√©, utiliser l'espacement sp√©cifique
      if (signatureData.detailedSpacing && specificSpacing !== undefined) {
        result = specificSpacing;
      } else {
        // Sinon, utiliser l'espacement global ou le fallback
        result = signatureData.spacings?.global || fallbackSpacing;
      }
      
      console.log(`üîç getSpacing - specific: ${specificSpacing}, fallback: ${fallbackSpacing}, detailedMode: ${signatureData.detailedSpacing}, global: ${signatureData.spacings?.global}, result: ${result}`);
      return result;
    };

    // Fonction helper pour cr√©er un espacement avec une cellule vide
    const createSpacingRow = (spacing) => {
      if (spacing <= 0) {
        console.log(`üîç createSpacingRow - spacing: ${spacing} (ignor√© car <= 0)`);
        return '';
      }
      const row = `<tr><td style="height: ${spacing}px; line-height: ${spacing}px; font-size: 1px;">&nbsp;</td></tr>`;
      console.log(`üîç createSpacingRow - spacing: ${spacing}px, row g√©n√©r√©:`, row);
      return row;
    };

    const profileImageHTML = signatureData.photo 
      ? `<img src="${signatureData.photo}" alt="Profile" style="width: ${signatureData.imageSize || 80}px; height: ${signatureData.imageSize || 80}px; border-radius: ${signatureData.imageShape === 'square' ? '8px' : '50%'}; background: url('${signatureData.photo}') center center / cover no-repeat; display: block;" />`
      : '';

    const logoHTML = signatureData.logo 
      ? `<img src="${signatureData.logo}" alt="Logo entreprise" style="max-width: ${signatureData.logoSize || 60}px; height: auto; display: block; margin: 0;" />`
      : '';

    const isHorizontal = signatureData.orientation === 'horizontal';

    if (isHorizontal) {
      return `
        <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse; font-family: ${signatureData.fontFamily || 'Arial, sans-serif'};">
          <tr>
            ${profileImageHTML ? `<td style="padding-right: 16px; vertical-align: top;">${profileImageHTML}</td>` : ''}
            <td style="vertical-align: top;">
              <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
                <tr>
                  <td style="font-size: ${signatureData.fontSize?.name || 16}px; font-weight: bold; color: ${signatureData.colors?.name || signatureData.primaryColor || '#2563eb'}; line-height: 1.2; padding: 0; margin: 0;">
                    ${signatureData.fullName || `${signatureData.firstName || ''} ${signatureData.lastName || ''}`.trim()}
                  </td>
                </tr>
                ${signatureData.position ? `
                  ${createSpacingRow(getSpacing(signatureData.spacings?.positionBottom, 8))}
                  <tr>
                    <td style="font-size: ${signatureData.fontSize?.position || 14}px; color: ${signatureData.colors?.position || 'rgb(102,102,102)'}; padding: 0; margin: 0;">
                      ${signatureData.position}
                    </td>
                  </tr>
                ` : ''}
                ${signatureData.phone ? `
                  ${createSpacingRow(getSpacing(signatureData.spacings?.phoneToMobile, 4))}
                  <tr>
                    <td style="font-size: ${signatureData.fontSize?.contact || 12}px; color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; padding: 0; margin: 0;">
                      üìû <a href="tel:${signatureData.phone}" style="color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; text-decoration: none;">${signatureData.phone}</a>
                    </td>
                  </tr>
                ` : ''}
                ${signatureData.email ? `
                  ${createSpacingRow(getSpacing(signatureData.spacings?.mobileToEmail, 4))}
                  <tr>
                    <td style="font-size: ${signatureData.fontSize?.contact || 12}px; color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; padding: 0; margin: 0;">
                      ‚úâÔ∏è <a href="mailto:${signatureData.email}" style="color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; text-decoration: none;">${signatureData.email}</a>
                    </td>
                  </tr>
                ` : ''}
                ${signatureData.website ? `
                  ${createSpacingRow(getSpacing(signatureData.spacings?.emailToWebsite, 4))}
                  <tr>
                    <td style="font-size: ${signatureData.fontSize?.contact || 12}px; color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; padding: 0; margin: 0;">
                      üåê <a href="${signatureData.website}" style="color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; text-decoration: none;">${signatureData.website}</a>
                    </td>
                  </tr>
                ` : ''}
                ${signatureData.address ? `
                  ${createSpacingRow(getSpacing(signatureData.spacings?.websiteToAddress, 4))}
                  <tr>
                    <td style="font-size: ${signatureData.fontSize?.contact || 12}px; color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; padding: 0; margin: 0;">
                      üìç ${signatureData.address}
                    </td>
                  </tr>
                ` : ''}
                ${createSpacingRow(getSpacing(signatureData.spacings?.separatorTop, 8))}
                <tr>
                  <td style="border-top: ${signatureData.separators?.horizontal?.width || 0.5}px solid ${signatureData.separators?.horizontal?.color || '#e0e0e0'}; height: 1px; line-height: 1px; font-size: 1px;">&nbsp;</td>
                </tr>
                ${logoHTML ? `
                  ${createSpacingRow(getSpacing(signatureData.spacings?.logoBottom, 8))}
                  <tr>
                    <td style="text-align: left; padding: 0; margin: 0;">
                      ${logoHTML}
                    </td>
                  </tr>
                ` : ''}
              </table>
            </td>
          </tr>
        </table>
      `;
    } else {
      // Version verticale avec tableaux et cellules vides pour les espacements
      return `
        <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse; font-family: ${signatureData.fontFamily || 'Arial, sans-serif'};">
          <tr>
            <td style="padding-right: ${getSpacing(signatureData.spacings?.verticalSeparatorLeft, 15)}px; vertical-align: top;">
              <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
                ${profileImageHTML ? `
                  <tr>
                    <td style="padding: 0; margin: 0;">
                      ${profileImageHTML}
                    </td>
                  </tr>
                  ${createSpacingRow(getSpacing(signatureData.spacings?.photoBottom, 12))}
                ` : ''}
                <tr>
                  <td style="font-size: ${signatureData.fontSize?.name || 16}px; font-weight: bold; color: ${signatureData.colors?.name || signatureData.primaryColor || '#2563eb'}; line-height: 1.2; padding: 0; margin: 0;">
                    ${signatureData.fullName || `${signatureData.firstName || ''} ${signatureData.lastName || ''}`.trim()}
                  </td>
                </tr>
                ${signatureData.position ? `
                  ${createSpacingRow(getSpacing(signatureData.spacings?.nameBottom, 8))}
                  <tr>
                    <td style="font-size: ${signatureData.fontSize?.position || 14}px; color: ${signatureData.colors?.position || 'rgb(102,102,102)'}; padding: 0; margin: 0;">
                      ${signatureData.position}
                    </td>
                  </tr>
                ` : ''}
                ${signatureData.companyName ? `
                  ${createSpacingRow(getSpacing(signatureData.spacings?.positionBottom, 8))}
                  <tr>
                    <td style="font-size: ${signatureData.fontSize?.position || 14}px; font-weight: bold; color: ${signatureData.colors?.company || signatureData.primaryColor || '#2563eb'}; padding: 0; margin: 0;">
                      ${signatureData.companyName}
                    </td>
                  </tr>
                ` : ''}
              </table>
            </td>
            <td style="width: ${signatureData.separators?.vertical?.width || 1}px; background-color: ${signatureData.separators?.vertical?.color || '#e0e0e0'}; font-size: 1px; line-height: 1px;">&nbsp;</td>
            <td style="padding-left: ${getSpacing(signatureData.spacings?.verticalSeparatorRight, 15)}px; vertical-align: top;">
              <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
                ${signatureData.phone ? `
                  <tr>
                    <td style="font-size: ${signatureData.fontSize?.contact || 12}px; color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; padding: 0; margin: 0;">
                      üìû <a href="tel:${signatureData.phone}" style="color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; text-decoration: none;">${signatureData.phone}</a>
                    </td>
                  </tr>
                  ${createSpacingRow(getSpacing(signatureData.spacings?.phoneToMobile, 6))}
                ` : ''}
                ${signatureData.mobile ? `
                  <tr>
                    <td style="font-size: ${signatureData.fontSize?.contact || 12}px; color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; padding: 0; margin: 0;">
                      üì± <a href="tel:${signatureData.mobile}" style="color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; text-decoration: none;">${signatureData.mobile}</a>
                    </td>
                  </tr>
                  ${createSpacingRow(getSpacing(signatureData.spacings?.mobileToEmail, 6))}
                ` : ''}
                ${signatureData.email ? `
                  <tr>
                    <td style="font-size: ${signatureData.fontSize?.contact || 12}px; color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; padding: 0; margin: 0;">
                      ‚úâÔ∏è <a href="mailto:${signatureData.email}" style="color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; text-decoration: none;">${signatureData.email}</a>
                    </td>
                  </tr>
                  ${createSpacingRow(getSpacing(signatureData.spacings?.emailToWebsite, 6))}
                ` : ''}
                ${signatureData.website ? `
                  <tr>
                    <td style="font-size: ${signatureData.fontSize?.contact || 12}px; color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; padding: 0; margin: 0;">
                      üåê <a href="${signatureData.website}" style="color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; text-decoration: none;">${signatureData.website}</a>
                    </td>
                  </tr>
                  ${createSpacingRow(getSpacing(signatureData.spacings?.websiteToAddress, 6))}
                ` : ''}
                ${signatureData.address ? `
                  <tr>
                    <td style="font-size: ${signatureData.fontSize?.contact || 12}px; color: ${signatureData.colors?.contact || 'rgb(102,102,102)'}; padding: 0; margin: 0;">
                      üìç ${signatureData.address}
                    </td>
                  </tr>
                  ${createSpacingRow(12)}
                ` : ''}
                ${createSpacingRow(getSpacing(signatureData.spacings?.separatorTop, 12))}
                <tr>
                  <td style="border-top: ${signatureData.separators?.horizontal?.width || 1}px solid ${signatureData.separators?.horizontal?.color || '#e0e0e0'}; height: 1px; line-height: 1px; font-size: 1px;">&nbsp;</td>
                </tr>
                ${logoHTML ? `
                  ${createSpacingRow(getSpacing(signatureData.spacings?.logoBottom, 12))}
                  <tr>
                    <td style="text-align: left; padding: 0; margin: 0;">
                      ${logoHTML}
                    </td>
                  </tr>
                ` : ''}
              </table>
            </td>
          </tr>
        </table>
      `;
    }
  };

  // Copier la signature dans le presse-papiers
  const copyToClipboard = async () => {
    const html = generateHTML(); // Utiliser la version compl√®te avec toutes les typographies
    
    // Debug : Afficher le HTML g√©n√©r√© et les espacements
    console.log('üîç HTML g√©n√©r√© pour la copie:', html);
    console.log('üîç Orientation actuelle:', signatureData.orientation);
    console.log('üîç Orientation horizontale?', signatureData.orientation === 'horizontal');
    console.log('üîç Espacements actuels:', signatureData.spacings);
    console.log('üîç Mode d√©taill√© activ√©:', signatureData.detailedSpacing);
    console.log('üîç Espacement global:', signatureData.spacings?.global);
    console.log('üîç Donn√©es signature compl√®tes:', signatureData);
    
    try {
      // Utiliser l'API moderne du clipboard pour copier du HTML format√©
      await navigator.clipboard.write([
        new ClipboardItem({
          "text/html": new Blob([html], { type: "text/html" }),
          "text/plain": new Blob([html.replace(/<[^>]*>/g, "")], { type: "text/plain" }),
        }),
      ]);
      return { success: true, message: 'Signature copi√©e avec formatage HTML' };
    } catch (error) {
      console.warn('‚ö†Ô∏è Erreur copie moderne, fallback vers texte:', error);
      // Fallback vers la m√©thode simple
      try {
        await navigator.clipboard.writeText(html);
        return { success: true, message: 'Signature copi√©e (texte brut)' };
      } catch {
        return { success: false, message: 'Erreur lors de la copie' };
      }
    }
  };

  // T√©l√©charger la signature en HTML
  const downloadHTML = () => {
    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Signature Email - ${signature.personalInfo.firstName} ${signature.personalInfo.lastName}</title>
        <style>
          body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
          ${generateCSS()}
        </style>
      </head>
      <body>
        <div class="signature-preview">
          ${generateHTML()}
        </div>
      </body>
      </html>
    `;

    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `signature-${signature.signatureName || 'email'}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  // Valider si la signature est compl√®te
  const validateSignature = () => {
    const errors = [];
    
    if (!signature.personalInfo.firstName) {
      errors.push('Le pr√©nom est requis');
    }
    
    if (!signature.personalInfo.lastName) {
      errors.push('Le nom est requis');
    }
    
    if (!signature.personalInfo.email) {
      errors.push('L\'email est requis');
    }

    return {
      isValid: errors.length === 0,
      errors,
    };
  };

  return {
    generateHTML,
    generateCSS,
    copyToClipboard,
    downloadHTML,
    validateSignature,
  };
}
